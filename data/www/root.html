<!DOCTYPE html>
<html lang="es">
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <!--<META HTTP-EQUIV="REFRESH" CONTENT="10;URL=/datos">-->
    <TITLE>Domoticae</TITLE>
    <link rel="stylesheet" type="text/css" href="css.css">
    <script>
      var reloadPeriod = 2000;
      var running = false;

      function actualiza(id,valor){
        var a=document.getElementById(id);
        a.innerHTML=valor;        
      };

      function actualizaModo(cadena,_tiempo){
        /* MODO_OFF=0   */
        /* MODO_ON=1  */
        /* MODO_AUTO=2 */          
        console.log("Modo: " + cadena + " Tiempo: " + _tiempo);
        var tiempo = " - tiempo restatante: " + _tiempo + " sg";

        var texto_off=document.getElementById("texto_off");
        var texto_on=document.getElementById("texto_on");
        var texto_auto=document.getElementById("texto_auto");        

        switch (cadena){
          case 0://MODO_OFF
            //var texto_off=document.getElementById("texto_off");
            texto_off.innerText="Off" + tiempo;
            texto_off.style.display="inline";
            document.getElementById("boton_off").style.display="none";

            //var texto_on=document.getElementById("texto_on");
            texto_on.innerText="";
            texto_on.style.display="none";
            document.getElementById("boton_on").style.display="inline";
            
            //var texto_auto=document.getElementById("texto_auto");
            texto_auto.innerText="";
            texto_auto.style.display="none";        
            document.getElementById("boton_auto").style.display="inline";
          break;
          
          case 1://MODO_ON
            //var texto_off=document.getElementById("texto_off");
            texto_off.innerText="";
            texto_off.style.display="none";
            document.getElementById("boton_off").style.display="inline";

            //var texto_on=document.getElementById("texto_on");
            texto_on.innerText="On" + tiempo;
            texto_on.style.display="inline";
            document.getElementById("boton_on").style.display="none";
            
            //var texto_auto=document.getElementById("texto_auto");
            texto_auto.innerText="";            
            texto_auto.style.display="none";
            document.getElementById("boton_auto").style.display="inline";
          break;
          
          case 2://MODO_AUTO
            //var texto_off=document.getElementById("texto_off");
            texto_off.innerText="";
            texto_off.style.display="none";
            boton_off = document.getElementById("boton_off").style.display="inline";

            //var texto_on=document.getElementById("texto_on");
            texto_on.innerText="";
            texto_on.style.display="none";
            document.getElementById("boton_on").style.display="inline";
            
            //var texto_auto=document.getElementById("texto_auto");
            texto_auto.innerText="Automatico";
            texto_auto.style.display="inline";
            document.getElementById("boton_auto").style.display="none";
          break;
        }
      }

      function loadValues(){
        if(!running) return;
        var xh = new XMLHttpRequest();
        xh.onreadystatechange = function(){
          if (xh.readyState == 4){
            if(xh.status == 200) {
              console.log("JSON: " + JSON)
              var res = JSON.parse(xh.responseText);
              //medidas
              //temepratura
              console.log("Temp: "+res.medidas.temperatura);
              actualiza("temperatura",res.medidas.temperatura + " \u00B0C");
              //consigna
              console.log("Consigna: "+res.medidas.consigna);
              actualiza("consigna",res.medidas.consigna + " \u00B0C");
              //humedad
              console.log("humedad: "+res.medidas.humedad);
              actualiza("humedad",res.medidas.humedad + " %");

              //salidas
              //caldera
              console.log("caldera: "+res.salidas.caldera);
              actualiza("caldera",(res.salidas.caldera==1?"On":"Off"));
              //seguridad
              console.log("seguridad: "+res.salidas.seguridad);
              actualiza("seguridad",(res.salidas.seguridad==1?"On":"Off"));

              //modo
              console.log("Modo: "+res.modo[0]);
              console.log("Tiempo: "+res.modo[1]);
              actualizaModo(res.modo[0],res.modo[1]);

              if(running) setTimeout(loadValues, reloadPeriod);
            } else running = false;
          }
        };
        xh.open("GET", "/estado", true);
        xh.send(null);
      };

      function run(){
        if(!running){
          running = true;
          loadValues();
        }
      }            

      function inicializa(){
        run(); 
      }
    </script>
  </HEAD>

  <BODY onload="inicializa()">
    <TABLE border="0" width="80%" cellpadding="0" cellspacing="0" width="300" class="tabla">
      <CAPTION>Valores</CAPTION>
      <TR class="modo2"><TD>Temperatura:</TD><TD id="temperatura"></TD></TR>
      <TR class="modo2"><TD>Consigna:</TD><TD id="consigna"></TD></TR>
      <TR class="modo2"><TD>Humedad:</TD><TD id="humedad"></TD></TR>
    </TABLE>

    <BR>

    <form action="/modo" id="form_id">
      <input type="hidden" id="modo" name="modo" value="0">
      <TABLE border="0" width="80%" cellpadding="0" cellspacing="0" width="300" class="tabla">
        <caption>Modo de funcionamiento</caption>
        <TR class="modo2">
          <TD id="modo_on">
            <p id="texto_on" style="display: inline;"></p><button id="boton_on" style="display: none;" onClick="document.getElementById('modo').value=1;document.getElementById('form_id').submit();">On</button>
          </TD>
        </tr>
        <TR class="modo2">
          <TD id="modo_off">
            <p id="texto_off" style="display: inline;"></p><button id="boton_off" style="display: none;" onClick="document.getElementById('modo').value=0;document.getElementById('form_id').submit();">Off</button>
          </TD>
        </tr>
        <TR class="modo2">
          <TD id="modo_auto">
            <p id="texto_auto" style="display: inline;"></p><button id="boton_auto" style="display: none;" onClick="document.getElementById('modo').value=2;document.getElementById('form_id').submit();">Automatico</button>
          </TD>
        </tr>
      </TABLE>
    </form>
    
    <BR>

    <TABLE border="0" width="80%" cellpadding="0" cellspacing="0" width="300" class="tabla">
      <caption>Reles</caption>
      <TR class="modo2"><TD>Caldera</TD><TD id="caldera"></TD></TR>
      <TR class="modo2"><TD>Seguridad</TD><TD id="seguridad"></TD></TR>
    </TABLE>
  </BODY>
</HTML>
